<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Puente Debug en CF</title>
<style>
  body { font-family: monospace; padding: 20px; color: #333; font-size: 12px; }
  .box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
  h3 { margin-top: 0; }
  #debug-log { background: #eee; padding: 10px; border: 1px solid #999; height: 200px; overflow-y: scroll; }
</style>
</head>
<body>

<div class="box">
  <h3>Estado del Puente</h3>
  <div id="status">Esperando mensaje de Chatwoot...</div>
</div>

<div class="box">
  <h3>Log de Eventos (Debug)</h3>
  <div id="debug-log">Iniciando listener...<br></div>
</div>

<script>
  // --- CONFIGURACIÓN ---
  const CRM_URL = "https://crm.altomarketing.com"; 
  const ATTRIBUTE_NAME = "id_espocrm"; // El nombre exacto del atributo
  // ---------------------

  function log(msg) {
    const logDiv = document.getElementById("debug-log");
    logDiv.innerHTML += ">> " + msg + "<br>";
    console.log(msg); // También lo mandamos a la consola F12
  }

  window.addEventListener("message", function(event) {
    log("Evento recibido. Origin: " + event.origin);

    // 1. Verificamos si trae datos
    if (!event.data) {
      log("El evento no tiene data.");
      return;
    }

    // A veces el data viene como string JSON y hay que parsearlo, a veces es objeto.
    let data = event.data;
    if (typeof data === 'string') {
       try { data = JSON.parse(data); } catch(e) { log("No es JSON válido"); }
    }

    // Chatwoot suele enviar muchas cosas, filtramos lo que nos importa
    // La estructura debe ser data.data.contact o similar
    if (!data || !data.data || !data.data.contact) {
      log("Data recibida, pero NO contiene info de contacto (ignorado).");
      // Imprimimos qué llegó para curiosear
      // log("Contenido: " + JSON.stringify(data)); 
      return;
    }

    // 2. ¡Tenemos contacto!
    const contacto = data.data.contact;
    const email = contacto.email;
    log("Contacto detectado: " + email);

    // 3. Buscamos el atributo personalizado
    const customAttributes = contacto.custom_attributes || {};
    log("Atributos encontrados: " + JSON.stringify(customAttributes));

    const espoID = customAttributes[ATTRIBUTE_NAME];
    
    const statusDiv = document.getElementById("status");

    if (espoID) {
      statusDiv.innerHTML = "<strong>¡ID ENCONTRADO!</strong> ID: " + espoID + "<br>Redirigiendo...";
      log("Redirigiendo a: " + CRM_URL + "/#Contact/view/" + espoID);
      
      // COMENTA ESTA LÍNEA SI QUIERES VER EL LOG SIN QUE SE VAYA LA PÁGINA
      window.location.replace(CRM_URL + "/#Contact/view/" + espoID);
      
    } else {
      statusDiv.innerHTML = "⚠️ Contacto sin ID vinculado (" + ATTRIBUTE_NAME + ").";
      log("El campo " + ATTRIBUTE_NAME + " está vacío o indefinido.");
      
      // Generamos los botones manuales
      let html = `<br><br>
        <a href="${CRM_URL}/#Contact/list" target="_blank" style="background:blue;color:white;padding:5px;">Buscar Manual</a>`;
      
      if (email) {
         html += ` <a href="${CRM_URL}/#Contact/list/where%5B0%5D%5Btype%5D=equals&where%5B0%5D%5Battribute%5D=emailAddress&where%5B0%5D%5Bvalue%5D=${encodeURIComponent(email)}" target="_blank" style="background:green;color:white;padding:5px;">Buscar por Email</a>`;
      }
      
      statusDiv.innerHTML += html;
    }
